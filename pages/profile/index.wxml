<!-- pages/profile/index.wxml -->
<view class="profile-container">
  <!-- 用户信息头部 -->
  <view class="profile-header">
    <view class="user-avatar">
      <text class="avatar-emoji">{{user.avatar}}</text>
    </view>
    <view class="user-info">
      <!-- 昵称显示/编辑 -->
      <view wx:if="{{!editingNickname}}" class="nickname-row" bindtap="startEditNickname">
        <text class="user-name">{{user.name}}</text>
        <text class="edit-icon">编辑</text>
      </view>
      <view wx:elif="{{editingNickname}}" class="nickname-edit-row">
        <input
          class="nickname-input"
          value="{{nicknameInput}}"
          placeholder="输入昵称"
          bindinput="onNicknameInput"
          bindblur="saveNickname"
          focus="{{editingNickname}}"
          maxlength="20"
        />
      </view>

      <!-- IP显示/编辑 -->
      <view wx:if="{{!editingIP}}" class="ip-row" bindtap="startEditIP">
        <text class="ip-text">{{user.ip || '未设置IP'}}</text>
        <text class="edit-icon small">编辑</text>
      </view>
      <view wx:elif="{{editingIP}}" class="ip-edit-row">
        <input
          class="ip-input"
          value="{{ipInput}}"
          placeholder="输入IP地址"
          bindinput="onIPInput"
          bindblur="saveIP"
          focus="{{editingIP}}"
          maxlength="50"
        />
      </view>

      <text class="join-time">加入互助第 {{user.joinDays}} 天</text>
    </view>
  </view>

  <!-- 统计卡片 -->
  <view class="stats-grid">
    <view class="stat-card">
      <view class="stat-icon help-given">
        <text>♥</text>
      </view>
      <text class="stat-number">{{user.helpGiven}}</text>
      <text class="stat-label">帮助他人</text>
    </view>
    <view class="stat-card">
      <view class="stat-icon help-received">
        <text>★</text>
      </view>
      <text class="stat-number">{{user.helpReceived}}</text>
      <text class="stat-label">获得帮助</text>
    </view>
  </view>

  <!-- 提供资源设置 -->
  <view class="settings-section">
    <text class="section-title">我的提供</text>
    <view class="resource-card">
      <!-- 资源标题和操作按钮 -->
      <view class="resource-header">
        <text class="resource-title">常备资源</text>
        <view class="resource-actions">
          <text
            wx:if="{{user.resources && user.resources.length > 0}}"
            class="btn-secondary"
            bindtap="clearResources"
          >
            清除
          </text>
          <text class="btn-primary" bindtap="editResources">
            编辑资源
          </text>
        </view>
      </view>

      <!-- 资源标签展示区域 -->
      <view class="resource-display-area">
        <!-- 有资源时显示标签 -->
        <view wx:if="{{user.resources && user.resources.length > 0}}" class="resource-tags">
          <text
            wx:for="{{user.resources}}"
            wx:key="*this"
            class="resource-tag-display"
          >
            {{item}}
          </text>
        </view>

        <!-- 无资源时显示提示 -->
        <view wx:else class="resource-empty">
          <text class="resource-empty-icon">■</text>
          <text class="resource-empty-text">暂无常备资源</text>
          <text class="resource-empty-hint">点击"编辑资源"添加可提供的物品</text>
        </view>
      </view>

      <!-- 资源说明 -->
      <text class="resource-desc">
        开启后，附近的求助者可以在地图上看到您大概位置有资源可提供。
      </text>

      <!-- 地图显示开关 -->
      <view class="toggle-row">
        <text class="toggle-label">展示在地图上</text>
        <view class="toggle-switch {{user.showOnMap ? 'active' : ''}}" bindtap="toggleMapVisibility">
          <view class="toggle-knob"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- 资源编辑弹窗 -->
  <view wx:if="{{showResourceModal}}" class="modal-overlay" bindtap="closeResourceModal">
    <view class="modal-content" catchtap="stopPropagation">
      <!-- 弹窗头部 -->
      <view class="modal-header">
        <text class="modal-title">编辑常备资源</text>
        <text class="modal-close-btn" bindtap="closeResourceModal">×</text>
      </view>

      <!-- 已选择的资源 -->
      <view class="modal-section">
        <text class="modal-section-title">
          已选择 <text class="count-badge">{{tempResources.length}}</text>
        </text>
        <view class="selected-resources" wx:if="{{tempResources.length > 0}}">
          <view
            wx:for="{{tempResources}}"
            wx:key="*this"
            class="selected-resource-item"
          >
            <text class="resource-name">{{item}}</text>
            <text class="remove-btn" catchtap="removeResource" data-resource="{{item}}">×</text>
          </view>
        </view>
        <view wx:else class="empty-hint">
          <text class="empty-icon">●</text>
          <text class="empty-text">还未选择任何资源</text>
        </view>
      </view>

      <!-- 预设资源 -->
      <view class="modal-section">
        <text class="modal-section-title">快速选择</text>
        <view class="preset-resources">
          <view
            wx:for="{{presetResources}}"
            wx:key="*this"
            class="preset-resource {{tempResources.includes(item) ? 'selected' : ''}}"
            catchtap="togglePresetResource"
            data-resource="{{item}}"
          >
            {{item}}
          </view>
        </view>
      </view>

      <!-- 自定义资源输入 -->
      <view class="modal-section custom-section">
        <text class="modal-section-title">自定义添加</text>
        <view class="custom-input-wrapper">
          <input
            class="custom-resource-input"
            placeholder="输入资源名称（如：红糖姜茶）"
            value="{{customResourceInput}}"
            bindinput="onCustomInput"
            bindconfirm="addCustomResource"
            maxlength="15"
          />
          <text class="add-custom-btn" catchtap="addCustomResource">添加</text>
        </view>
      </view>

      <!-- 弹窗底部按钮 -->
      <view class="modal-footer">
        <text class="modal-btn cancel-btn" bindtap="closeResourceModal">取消</text>
        <text class="modal-btn confirm-btn" catchtap="confirmResourceSelection">保存</text>
      </view>
    </view>
  </view>

  <!-- 设置菜单 -->
  <view class="settings-section-2">
    <text class="section-title">设置</text>
    <view class="menu-list">
      <view class="menu-item" bindtap="goToSettings">
        <view class="menu-item-content">
          <text class="menu-icon">设置</text>
          <text class="menu-text">隐私设置</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item" bindtap="showAbout">
        <view class="menu-item-content">
          <text class="menu-icon">关于</text>
          <text class="menu-text">关于我们</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
    </view>
  </view>

  <!-- 底部版权 -->
  <view class="footer">
    <text class="footer-text">Girls Help Girls · Light App</text>
  </view>

  <!-- 背景图片 -->
  <image class="background-image" src="/images/profile_back.jpg" mode="scaleToFill"></image>
</view>
