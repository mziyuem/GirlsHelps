<!--pages/chat/index.wxml-->
<view class="chat-container">
  <!-- èŠå¤©å¤´éƒ¨ -->
  <view class="chat-header">
    <view class="header-left" bindtap="goBack">
      <image class="back-icon" src="/images/icon1.png" mode="aspectFit"></image>
    </view>
    <view class="header-center">
      <text class="header-title">{{otherUserInfo.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
    </view>
    <view class="header-right">
      <!-- å®Œæˆå¯¹è¯æŒ‰é’®ï¼šåªå¯¹è¯·æ±‚è€…æ˜¾ç¤ºï¼Œä¸”åœ¨activeçŠ¶æ€æ—¶ -->
      <view wx:if="{{showCompleteButton}}" class="complete-button" bindtap="completeHelpRequest">
        <text class="complete-icon">âœ“</text>
      </view>
    </view>
  </view>

  <!-- èœ¡çƒ›é è¿‘åŠŸèƒ½ï¼šåªå¯¹è¯·æ±‚è€…æ˜¾ç¤ºï¼Œå½“æœ‰åŒ¹é…è€…æ—¶ -->
  <view wx:if="{{showCandle}}" class="candle-banner" bindtap="showHelpersList">
    <view class="candle-icon-wrapper">
      <text class="candle-icon">ğŸ•¯ï¸</text>
    </view>
    <text class="candle-text">ç‚¹å‡»æŸ¥çœ‹å¯æä¾›å¸®åŠ©è€…</text>
  </view>

  <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="chat-messages" scroll-y scroll-into-view="{{lastMessageId}}" scroll-with-animation>
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view wx:for="{{messages}}" wx:key="messageId" id="{{item.messageId}}" class="message-item">

      <!-- å¯¹æ–¹çš„æ¶ˆæ¯ï¼šä»å·¦åˆ°å³ [å¤´åƒ] [æ¶ˆæ¯]ï¼Œé å·¦å¯¹é½ -->
      <view wx:if="{{item.senderId !== currentUserId}}" class="message-row message-row-left">
        <image class="message-avatar" src="{{otherUserInfo.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
        <view class="message-content">
          <text class="message-bubble message-bubble-left">{{item.content}}</text>
        </view>
      </view>

      <!-- è‡ªå·±çš„æ¶ˆæ¯ï¼šä»å·¦åˆ°å³ [å¤´åƒ] [æ¶ˆæ¯]ï¼Œä½†é å³å¯¹é½ -->
      <view wx:if="{{item.senderId === currentUserId}}" class="message-row message-row-right">
        <view class="message-content">
          <text class="message-bubble message-bubble-right">{{item.content}}</text>
        </view>
        <image class="message-avatar" src="{{currentUserInfo.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
      </view>

    </view>

    <!-- æ‰“å­—ä¸­æç¤º -->
    <view wx:if="{{isTyping}}" class="message-item">
      <view class="message-row message-row-left">
        <image class="message-avatar" src="{{otherUserInfo.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
        <view class="message-content">
          <view class="typing-indicator">
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="chat-input-area">
    <textarea
      class="chat-input"
      placeholder="è¾“å…¥æ¶ˆæ¯..."
      value="{{inputText}}"
      bindinput="onInput"
      bindconfirm="sendMessage"
      disabled="{{isTyping}}"
      show-confirm-bar="{{false}}"
      auto-height
      maxlength="500"
      adjust-position="{{true}}"
    ></textarea>
    <view
      class="send-button {{inputText.trim() ? 'active' : ''}}"
      bindtap="sendMessage"
    >
      <text>å‘é€</text>
    </view>
  </view>
</view>

<!-- å¸®åŠ©è€…åˆ—è¡¨å¼¹çª— -->
<view wx:if="{{showHelpersModal}}" class="modal-overlay" catchtap="closeHelpersModal">
  <view class="helpers-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">å¯æä¾›å¸®åŠ©è€…</text>
      <view class="modal-close" catchtap="closeHelpersModal">
        <text>âœ•</text>
      </view>
    </view>
    <view class="helpers-list">
      <view
        wx:for="{{helpersList}}"
        wx:key="openid"
        class="helper-item"
        bindtap="selectHelper"
        data-id="{{item.openid}}"
      >
        <view class="helper-avatar">
          <image wx:if="{{item.avatarUrl}}" src="{{item.avatarUrl}}" mode="aspectFill"></image>
          <view wx:else class="default-avatar-small">{{item.nickname ? item.nickname.substr(0,1) : 'U'}}</view>
        </view>
        <view class="helper-info">
          <text class="helper-name">{{item.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
          <text class="helper-distance">{{item.distance}}kmä»¥å†…</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å®Œæˆäº’åŠ©å¼¹çª— -->
<view wx:if="{{showCompleteModal}}" class="modal-overlay" catchtap="closeCompleteModal">
  <view class="complete-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">å®Œæˆäº’åŠ©</text>
      <view class="modal-close" catchtap="closeCompleteModal">
        <text>âœ•</text>
      </view>
    </view>
    <view class="complete-content">
      <view class="complete-tip">
        <text class="tip-icon">âœ“</text>
        <text>åŒæ–¹å·²åå•†å¥½ï¼Œå‡†å¤‡å®Œæˆäº’åŠ©</text>
      </view>
      <view class="form-group">
        <text class="form-label">åå•†åœ°ç‚¹</text>
        <input
          class="form-input"
          placeholder="ä¾‹å¦‚ï¼š1å·é—¨å¤–å–å¥¶èŒ¶åº—"
          value="{{meetingLocation}}"
          bindinput="onLocationInput"
          maxlength="100"
        />
      </view>
      <view class="form-group">
        <text class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</text>
        <textarea
          class="form-textarea"
          placeholder="å¯ä»¥è®°å½•ä¸€ä¸‹äº’åŠ©çš„ç»†èŠ‚..."
          value="{{meetingNotes}}"
          bindinput="onNotesInput"
          maxlength="200"
          show-confirm-bar="{{false}}"
          auto-height
        ></textarea>
      </view>
      <view class="complete-actions">
        <view class="action-button cancel-button" catchtap="closeCompleteModal">
          <text>å–æ¶ˆ</text>
        </view>
        <view class="action-button confirm-button" catchtap="confirmComplete">
          <text>ç¡®è®¤å®Œæˆ</text>
        </view>
      </view>
    </view>
  </view>
</view>
